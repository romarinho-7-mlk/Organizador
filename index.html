<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SuportAdd</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    :root{--bg:#3e4754;--card:#04364bfb;--muted:#048487;--accent:#06b6d4;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui;color:#002e37;background:linear-gradient(180deg,#cfe9f6 0%, hsl(182, 100%, 95%) 100%)}
    .app{display:grid;grid-template-columns:280px 1fr;gap:20px;height:100vh;padding:20px}
    .sidebar{background:var(--card);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:12px}
    .logo{font-weight:700;color:var(--accent);font-size:18px}
    .pages{flex:1;overflow:auto}
    .page{background:var(--glass);padding:8px;border-radius:8px;margin-bottom:8px;cursor:pointer}
    .page.active{outline:2px solid rgba(255, 3, 3, 0.069)}
    .new-page{display:flex;gap:8px}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;transition:background .2s}
    .btn:hover{background:var(--muted)}
    .btn-delete{background:#dc2626}
    .btn-delete:hover{background:#b91c1c}
    .main-content{background:#fff;border-radius:12px;padding:20px;display:flex;flex-direction:column;gap:15px;overflow:auto}
    .header-main{display:flex;justify-content:space-between;align-items:center}
    .tools{display:flex;gap:10px}
    .search{padding:8px 12px;border-radius:6px;border:1px solid #ccc;width:250px}
    .blocks-container{flex:1;overflow:auto;display:flex;flex-direction:column;gap:15px;padding-right:10px}
    .block-card{background:#f9fafb;border-left:4px solid var(--accent);padding:15px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);cursor:pointer}
    .block-card:hover{box-shadow:0 2px 5px rgba(0,0,0,0.1)}
    .block-content{overflow:hidden}
    .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:600px;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:15px}
    .hidden{display:none}
    .ql-toolbar.ql-snow, .ql-container.ql-snow{border:1px solid #ccc;border-radius:4px}
  </style>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.snow.css" rel="stylesheet" />
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="logo">SuportAdd</div>
      <div class="new-page">
        <input type="text" id="newPageInput" placeholder="Nome da nova página" class="search" style="flex:1" />
        <button id="addPageBtn" class="btn">+</button>
        <button id="deletePageBtn" class="btn btn-delete">Lixeira</button>
      </div>
      <div id="pagesContainer" class="pages">
        </div>
      <button id="logoutBtn" class="btn btn-delete">Sair</button>
    </div>
    <div class="main-content">
      <div class="header-main">
        <h2 id="pageTitle">Selecione uma Página</h2>
        <div class="tools">
          <input type="text" id="searchBar" placeholder="Buscar por texto..." class="search" />
          <button id="addTextBtn" class="btn">Adicionar Bloco</button>
          <button id="generatePdfBtn" class="btn">Gerar PDF</button>
        </div>
      </div>
      <div id="blocksContainer" class="blocks-container">
        </div>
    </div>
  </div>

  <div id="newBlockModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Adicionar Novo Bloco de Texto</h3>
        <button id="closeModalBtn" class="btn btn-delete">X</button>
      </div>
      <div id="newBlockEditor"></div>
      <div class="modal-actions">
        <button id="saveModalBtn" class="btn">Salvar</button>
      </div>
    </div>
  </div>

  <div id="editBlockModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Bloco de Texto</h3>
        <button id="closeEditModalBtn" class="btn btn-delete">X</button>
      </div>
      <div id="editModalEditor"></div>
      <input type="hidden" id="editModalBlockId" value="" />
      <div class="modal-actions">
        <button id="deleteBtn" class="btn btn-delete">Excluir Bloco</button>
        <button id="saveEditModalBtn" class="btn">Salvar Alterações</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.js"></script>
  <script>
    // Configuração do Supabase e variáveis globais
    const supabaseUrl = 'SUA_URL_SUPABASE'; // Substitua pela sua URL
    const supabaseKey = 'SUA_CHAVE_PUBLICA_ANON'; // Substitua pela sua chave pública
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    let activePageId = null;
    let pages = [];
    let blocks = [];
    const newBlockModal = document.getElementById('newBlockModal');
    const editBlockModal = document.getElementById('editBlockModal');
    const editModalBlockId = document.getElementById('editModalBlockId');
    const pageTitle = document.getElementById('pageTitle');
    const blocksContainer = document.getElementById('blocksContainer');
    const pagesContainer = document.getElementById('pagesContainer');
    const searchBar = document.getElementById('searchBar');

    let newBlockQuill;
    let editBlockQuill;

    // --- Funções de Inicialização e Renderização (Mantenho a estrutura) ---

    // Função para carregar páginas
    async function loadPages() { /* ... código existente ... */ }
    
    // Função para renderizar páginas
    function renderPages() { /* ... código existente ... */ }

    // Função para ativar página
    async function setActivePage(pageId) { /* ... código existente ... */ }

    // Função para criar página
    async function createPage(name) { /* ... código existente ... */ }

    // Função para deletar página
    async function deletePage(pageId) { /* ... código existente ... */ }

    // Função para carregar blocos
    async function loadBlocks(pageId) { /* ... código existente ... */ }
    
    // Função para renderizar blocos
    function renderBlocks(filter = '') { /* ... código existente ... */ }
    
    // Função para abrir modal de novo bloco
    function openNewBlockModal() { /* ... código existente ... */ }

    // Função para fechar modal de novo bloco
    function closeNewBlockModal() { /* ... código existente ... */ */ }

    // Função para lidar com novo bloco
    async function handleNewBlock() { /* ... código existente ... */ }

    // Função para abrir modal de edição
    function openEditModal(blockId, content) { /* ... código existente ... */ }

    // Função para salvar edição
    async function handleSaveEdit() { /* ... código existente ... */ }

    // Função para fechar modal de edição
    function closeEditModal(){ /* ... código existente ... */ }

    // Função para deletar bloco
    async function deleteBlock(blockId) { /* ... código existente ... */ }


    // --- NOVA FUNÇÃO PARA GERAR PDF ---
    async function generatePDF() {
      if (!activePageId) {
        alert('Selecione uma página para gerar o PDF.');
        return;
      }

      const container = document.getElementById('blocksContainer');
      const pageName = document.getElementById('pageTitle').textContent;
      
      // 1. Oculta botões de edição/exclusão temporariamente antes de gerar a imagem
      const editButtons = container.querySelectorAll('.edit-btn-pdf-exclude');
      editButtons.forEach(btn => btn.style.display = 'none');
      
      const spinner = document.createElement('div');
      spinner.textContent = 'Gerando PDF...';
      spinner.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:10px;z-index:9999;';
      document.body.appendChild(spinner);

      try {
        // Inicializa jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfMargin = 10;
        const targetWidth = pdfWidth - 2 * pdfMargin; // 190mm para A4

        // 2. Converte o conteúdo do container para Canvas (incluindo estilos)
        // O html2canvas é necessário para renderizar HTML/CSS complexo como imagem.
        const canvas = await html2canvas(container, {
          scale: 2, // Maior escala para melhor qualidade no PDF
          useCORS: true,
          logging: false
        });

        const imgData = canvas.toDataURL('image/png');
        const imgHeight = canvas.height * targetWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        // 3. Adiciona a imagem no PDF (com suporte a múltiplas páginas)
        doc.text(pageName, pdfMargin, pdfMargin); // Título da página no topo

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;

          // Adiciona a página atual/nova
          doc.addImage(imgData, 'PNG', pdfMargin, position + pdfMargin + 10, targetWidth, imgHeight); 
          
          heightLeft -= (doc.internal.pageSize.getHeight() - pdfMargin * 2);

          // Adiciona uma nova página se houver mais conteúdo
          if (heightLeft > 0) {
            doc.addPage();
          }
        }
        
        // 4. Salva o arquivo
        doc.save(`${pageName.replace(/[^a-z0-9]/gi, '_')}.pdf`);

      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert('Ocorreu um erro ao gerar o PDF.');
      } finally {
        // 5. Restaura botões
        editButtons.forEach(btn => btn.style.display = '');
        spinner.remove();
      }
    }


    // --- Eventos ---
    document.getElementById('addPageBtn').onclick=()=>{createPage(document.getElementById('newPageInput').value.trim()||'Nova página');};
    document.getElementById('deletePageBtn').onclick=()=>{if(activePageId) deletePage(activePageId);};
    document.getElementById('addTextBtn').onclick=openNewBlockModal;
    document.getElementById('closeModalBtn').onclick=closeNewBlockModal;
    document.getElementById('saveModalBtn').onclick=handleNewBlock;
    document.getElementById('closeEditModalBtn').onclick=closeEditModal;
    document.getElementById('saveEditModalBtn').onclick=handleSaveEdit;
    document.getElementById('deleteBtn').onclick=()=>deleteBlock(editModalBlockId.value);
    document.getElementById('logoutBtn').onclick=async()=>{await supabase.auth.signOut();};
    searchBar.oninput=(e)=>renderBlocks(e.target.value);
    
    // NOVO EVENTO: Botão Gerar PDF
    document.getElementById('generatePdfBtn').onclick = generatePDF;


    supabase.auth.onAuthStateChange((ev,session)=>{if(ev==='SIGNED_OUT'){window.location.href='auth.html';}else if(session){currentUser=session.user; loadPages();}});\
    supabase.auth.getSession().then(({data:{session}})=>{if(session){currentUser=session.user; loadPages();}});\
  </script>
</body>
</html>
