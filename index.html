<!doctype html>
<html lang="pt-BR">
<<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SuportAdd</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    /* ... Seu CSS completo (sem alterações) ... */
    :root{--bg:#3e4754;--card:#04364bfb;--muted:#048487;--accent:#06b6d4;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui;color:#002e37;background:linear-gradient(180deg,#cfe9f6 0%, hsl(182, 100%, 95%) 100%)}
    .app{display:grid;grid-template-columns:280px 1fr;gap:20px;height:100vh;padding:20px}
    .sidebar{background:var(--card);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:12px}
    .logo{font-weight:700;color:var(--accent);font-size:18px}
    .pages{flex:1;overflow:auto}
    .page{background:var(--glass);padding:8px;border-radius:8px;margin-bottom:8px;cursor:pointer}
    .page.active{outline:2px solid rgba(255, 3, 3, 0.069)}
    .new-page{display:flex;gap:8px}
    .btn{background:white;border:1px solid rgba(116, 116, 116, 0.963);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .main{padding:18px;}
    .card{background:#f0f9f9;padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(1, 1, 1, 0.6)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .controls{display:flex;gap:8px}

    .btn {
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-weight: bold;
      background: linear-gradient(to right, #007bff, #0056b3);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: background 0.3s ease;
    }
    .btn:hover { background: linear-gradient(to right, #0056b3, #007bff); }
    .btn:active { transform: translateY(1px); }
    .danger { background: #dc3545; color: white; }
    .danger:hover { background: #c82333; }

    .blocks { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .block, .attach-item {
      background:#01646415;
      padding:12px;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0, 0, 0, 0.114);
      display:flex;
      flex-direction:column;
      gap:8px;
      cursor: pointer;
    }
    .block h3, .block p { margin: 0; }

    .title-input { font-weight:bold; border:1px solid #ccc; padding:6px; border-radius:8px; }

    input[type=file]{display:none}
    @media(max-width:860px){
      .app{grid-template-columns:1fr;grid-auto-rows:auto;overflow:auto;height:auto}
      .sidebar{order:2}
      .blocks{grid-template-columns:1fr}
    }

    dialog {
      border: none;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      max-width: 900px;
      width: 90%;
      background: #fff;
    }
    dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
    .modal-content { display: flex; flex-direction: column; gap: 16px; }
    .modal-content input, .modal-content .btn { width: 100%; }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 8px; }

    #editModalFileList, #modalFileList {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .attach-item img { max-width: 100%; height: auto; margin-bottom: 8px; border-radius: 6px; }
    .attach-item .actions { display: flex; gap: 8px; }
  </style>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTK+Q4lW6Z0bJ8L5F2U0C8F6E4A0S9R1B1X8E4F8A6B9P2C1N1A4H4E5G6C7D8F9G0A1" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-Y3H8M2K2E2G4K4F5T5H6G7B8A9C1D0E0F1A2B3C4D5E6F7G8H9I0J1K2L3M4N5O6P7Q8R9S0T1U2V3W4X5Y6Z7" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

</head>
<body>
  <div class="app">
    <aside class="sidebar card">
      <div class="logo">Suport - ADD </div>
      <div class="pages" id="pages"></div>
      <div class="new-page">
        <input id="newPageInput" class="btn" placeholder="Nome da página" />
        <button id="addPageBtn" class="btn">Criar</button>
      </div>
    </aside>

    <main class="main">
      <div class="card">
        <header>
          <h1 id="pageTitle">Página</h1>
          <input type="text" id="searchBar" class="btn" placeholder="Pesquisar..." />
          <div class="controls">
            <button id="addTextBtn" class="btn">Adicionar bloco de texto</button>
            <button id="generatePdfBtn" class="btn">Gerar PDF</button>
            <button id="deletePageBtn" class="btn danger">Excluir página</button>
            <button id="logoutBtn" class="btn danger">Sair</button>
          </div>
        </header>
        <section class="blocks" id="blocksContainer"></section>
      </div>
    </main>
  </div>

  <dialog id="newBlockModal">
    <div class="modal-content">
      <h2>Novo Bloco de Texto</h2>
      <input type="text" id="modalTitle" placeholder="Novo tópico" class="title-input" />
      <div id="modalEditor"></div>
      <div class="file-upload">
        <label class="btn">Adicionar arquivos
          <input type="file" id="modalFiles" multiple />
        </label>
        <div id="modalFileList"></div>
      </div>
      <div class="modal-buttons">
        <button id="closeModalBtn" class="btn">Cancelar</button>
        <button id="saveModalBtn" class="btn">Salvar</button>
      </div>
    </div>
  </dialog>

  <dialog id="editBlockModal">
    <div class="modal-content">
      <input type="hidden" id="editModalBlockId" />
      <h2>Detalhes do Bloco</h2>
      <input type="text" id="editModalTitleInput" class="title-input" />
      <div id="editModalEditor"></div>
      <div class="file-upload">
        <label class="btn">Adicionar arquivos
          <input type="file" id="editModalFilesInput" multiple />
        </label>
      </div>
      <div id="editModalFileList"></div>
      <div class="modal-buttons">
        
        <button id="generateBlockPdfBtn" class="btn">Gerar PDF do Bloco</button>
        <button id="closeEditModalBtn" class="btn">Fechar</button>
        <button id="saveEditModalBtn" class="btn">Salvar Alterações</button>
        <button id="deleteBtn" class="btn danger">Excluir Bloco</button>
      </div>
    </div>
  </dialog>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://ybpyncfnzfrobqcuiyqr.supabase.co";
    // Usando a chave do seu arquivo anterior, que estava funcionando
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicHluY2ZuemZyb2JxY3VpeXFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMzY0MDUsImV4cCI6MjA3MzcxMjQwNX0.s_vaIyn8kDkORC2nW-aOgk_4f3ZlsGNqxjgPGFfjVBc";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- Variáveis globais ---
    const pagesEl = document.getElementById('pages');
    const blocksContainer = document.getElementById('blocksContainer');
    const pageTitle = document.getElementById('pageTitle');
    const newBlockModal = document.getElementById('newBlockModal');
    const modalTitleInput = document.getElementById('modalTitle');
    const modalFilesInput = document.getElementById('modalFiles');
    const modalFileListDiv = document.getElementById('modalFileList');
    const editBlockModal = document.getElementById('editBlockModal');
    const editModalBlockId = document.getElementById('editModalBlockId');
    const editModalTitleInput = document.getElementById('editModalTitleInput');
    const editModalFileList = document.getElementById('editModalFileList');
    const editModalFilesInput = document.getElementById('editModalFilesInput');
    const searchBar = document.getElementById('searchBar');

    let pages = [], activePageId = null, currentUser = null, currentBlocks = [], filesToUpload = [];

    // --- Páginas ---
    async function loadPages(){
      if (!currentUser) return;
      const { data } = await supabase.from('pages').select('*').order('created_at',{ascending:false});
      pages = data || [];
      activePageId = pages[0]?.id || null;
      renderPages(); render();
    }
    async function createPage(title){
      if (!currentUser) return alert("Precisa logar");
      const { data } = await supabase.from('pages').insert({ title, user_id: currentUser.id }).select().single();
      pages.unshift(data); activePageId=data.id; renderPages(); render();
    }
    async function deletePage(id){
      if(!confirm("Excluir página?")) return;
      await supabase.from('pages').delete().eq('id',id);
      pages = pages.filter(p=>p.id!==id); activePageId=pages[0]?.id||null; renderPages(); render();
    }
    function renderPages(){
      pagesEl.innerHTML=''; 
      pages.forEach(p=>{
        const div=document.createElement('div');
        div.className='page'+(p.id===activePageId?' active':'');
        div.textContent=p.title;
        div.onclick=()=>{activePageId=p.id; render();};
        pagesEl.appendChild(div);
      });
    }

    // --- Blocos ---
    async function loadBlocks(){
      if(!activePageId) return [];
      const { data } = await supabase.from('blocks').select('*').eq('page_id',activePageId).order('created_at');
      currentBlocks=data||[]; return currentBlocks;
    }
    async function handleNewBlock(){
      if(!currentUser||!activePageId) return alert("Precisa logar");
      const title=modalTitleInput.value.trim()||"Novo tópico";
      const content=$('#modalEditor').summernote('code').trim();
      const { data }=await supabase.from('blocks').insert({page_id:activePageId,title,content,user_id:currentUser.id}).select().single();
      currentBlocks.push(data); 
      closeNewBlockModal(); 
      // CORREÇÃO: Chama render() para recarregar do DB e garantir que o novo bloco apareça.
      render(); 
    }
    async function updateBlock(id,fields){ await supabase.from('blocks').update(fields).eq('id',id); }
    async function deleteBlock(id){ if(confirm("Excluir bloco?")){await supabase.from('blocks').delete().eq('id',id); render();} }

    function renderBlocks(term=''){
      blocksContainer.innerHTML='';
      // CORREÇÃO: Adicionado '?' (optional chaining) para evitar erro se 'content' for nulo no filtro.
      currentBlocks.filter(b=>b.title.toLowerCase().includes(term.toLowerCase())||b.content?.toLowerCase().includes(term.toLowerCase()))
      .forEach(b=>{
        const card=document.createElement('div');
        card.className='block';
        // CORREÇÃO: Adicionado '|| ''' (fallback) para evitar erro no display de blocos antigos com content nulo.
        card.innerHTML=`<h3>${b.title}</h3><div>${b.content || ''}</div>`;
        card.onclick=()=>openEditModal(b);
        blocksContainer.appendChild(card);
      });
    }
    async function render(){ const p=pages.find(x=>x.id===activePageId); if(!p){pageTitle.textContent='Nenhuma página';return;} pageTitle.textContent=p.title; await loadBlocks(); renderBlocks(searchBar.value); }

    // --- Modais ---
    function openNewBlockModal(){ 
      $('#modalEditor').summernote({
        height: 300,
        toolbar: [
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['font', ['strikethrough', 'superscript', 'subscript']],
            ['fontsize', ['fontsize']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['height', ['height']],
            ['insert', ['link', 'picture', 'video']],
            ['view', ['fullscreen', 'codeview', 'help']]
        ]
      });
      newBlockModal.showModal(); 
    }
    function closeNewBlockModal(){ 
      $('#modalEditor').summernote('destroy');
      newBlockModal.close(); 
      modalTitleInput.value=''; 
      modalFilesInput.value=null; 
      modalFileListDiv.innerHTML=''; 
      filesToUpload=[]; 
    }
    function openEditModal(b){ 
      editModalBlockId.value=b.id; 
      editModalTitleInput.value=b.title; 
      $('#editModalEditor').summernote({
        height: 300,
        toolbar: [
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['font', ['strikethrough', 'superscript', 'subscript']],
            ['fontsize', ['fontsize']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['height', ['height']],
            ['insert', ['link', 'picture', 'video']],
            ['view', ['fullscreen', 'codeview', 'help']]
        ]
      });
      $('#editModalEditor').summernote('code', b.content || '');
      editBlockModal.showModal(); 
    }
    
    // CORREÇÃO ESSENCIAL: Adicionado 'async' e 'await' E FEEDBACK VISUAL
    async function handleSaveEdit(){ 
      // 1. Pega os botões do modal de edição
      const saveBtn = document.getElementById('saveEditModalBtn');
      const closeBtn = document.getElementById('closeEditModalBtn');
      
      // 2. Desabilita botões e mostra feedback
      saveBtn.textContent = 'Salvando...';
      saveBtn.disabled = true;
      closeBtn.disabled = true;

      try {
          // O AWAIT garante que a execução espere a confirmação do Supabase.
          await updateBlock(editModalBlockId.value,{title:editModalTitleInput.value,content:$('#editModalEditor').summernote('code').trim()}); 
          
          editBlockModal.close(); 
          render(); 
      } catch (error) {
          console.error("Erro ao salvar o bloco:", error);
          alert("Ocorreu um erro ao salvar!");
      } finally {
          // 3. Restaura botões, independentemente do sucesso ou falha
          saveBtn.textContent = 'Salvar Alterações';
          saveBtn.disabled = false;
          closeBtn.disabled = false;
      }
    }
    
    function closeEditModal(){
      $('#editModalEditor').summernote('destroy');
      editBlockModal.close();
    }

    // --- Funções PDF (ADICIONADAS) ---
    // Função para gerar PDF de todos os blocos (mantida)
    async function generatePDF() {
      if (!activePageId) {
        alert('Selecione uma página para gerar o PDF.');
        return;
      }
      
      // ... Lógica para gerar PDF de todos os blocos (mantida) ...

      const container = document.getElementById('blocksContainer');
      const pageName = document.getElementById('pageTitle').textContent.trim() || 'Documento';
      
      const spinner = document.createElement('div');
      spinner.textContent = 'Gerando PDF...';
      spinner.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:10px;z-index:9999;';
      document.body.appendChild(spinner);

      try {
        const editButtons = container.querySelectorAll('.block .btn'); 
        editButtons.forEach(btn => btn.style.display = 'none');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfMargin = 10;
        const targetWidth = pdfWidth - 2 * pdfMargin; 
        
        const canvas = await html2canvas(container, {
          scale: 2, 
          useCORS: true,
          logging: false
        });

        doc.setFontSize(16);
        doc.text(`Relatório: ${pageName}`, pdfMargin, pdfMargin);
        let yOffset = pdfMargin + 10; 
        
        const imgData = canvas.toDataURL('image/png');
        const imgHeight = canvas.height * targetWidth / canvas.width;
        
        const pageHeight = doc.internal.pageSize.getHeight();
        let heightLeft = imgHeight;
        let pageNumber = 1;

        while (heightLeft > 0) {
            let sHeight = pageHeight - yOffset - pdfMargin; 
            let sourceY = imgHeight - heightLeft; 

            if (pageNumber > 1) {
                doc.addPage();
                yOffset = pdfMargin; 
                sHeight = pageHeight - yOffset - pdfMargin;
            }

            let canvasCrop = document.createElement('canvas');
            let ctx = canvasCrop.getContext('2d');
            canvasCrop.width = canvas.width;
            
            let cropHeightPx = canvas.height * sHeight / imgHeight; 
            
            if (cropHeightPx > canvas.height - sourceY) {
                cropHeightPx = canvas.height - sourceY;
                sHeight = imgHeight * cropHeightPx / canvas.height;
            }
            
            canvasCrop.height = cropHeightPx;
            
            ctx.drawImage(canvas, 
                0, sourceY, 
                canvas.width, cropHeightPx, 
                0, 0, 
                canvas.width, cropHeightPx 
            );
            
            let croppedImgData = canvasCrop.toDataURL('image/png');

            doc.addImage(
                croppedImgData, 
                'PNG', 
                pdfMargin, 
                yOffset, 
                targetWidth, 
                sHeight
            ); 

            heightLeft -= sHeight;
            yOffset += sHeight; 
            pageNumber++;
        }
        
        doc.save(`${pageName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);

      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert('Ocorreu um erro ao gerar o PDF de todos os blocos.');
      } finally {
        const editButtons = container.querySelectorAll('.block .btn');
        editButtons.forEach(btn => btn.style.display = '');
        spinner.remove();
      }
    }

    // === 2. ADIÇÃO: Nova função para gerar PDF de um Bloco específico ===
    async function generateBlockPDF() {
      const title = editModalTitleInput.value.trim() || 'Novo tópico';
      const content = $('#editModalEditor').summernote('code');
      
      const spinner = document.createElement('div');
      spinner.textContent = 'Gerando PDF...';
      spinner.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:10px;z-index:9999;';
      document.body.appendChild(spinner);
      
      try {
          const tempDiv = document.createElement('div');
          tempDiv.style.padding = '20px'; // Adiciona um padding para margem visual
          tempDiv.innerHTML = `
              <h1 style="margin-bottom: 20px;">${title}</h1>
              <div style="font-size: 14px;">${content}</div>
          `;
          
          // Adiciona a div temporária ao corpo para que o html2canvas possa vê-la
          document.body.appendChild(tempDiv);

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('p', 'mm', 'a4');
          const pdfWidth = doc.internal.pageSize.getWidth();
          const pdfMargin = 10;
          const targetWidth = pdfWidth - 2 * pdfMargin;
          
          // Gera o Canvas a partir da div temporária
          const canvas = await html2canvas(tempDiv, {
              scale: 2,
              useCORS: true,
              logging: false,
          });

          // Lógica de múltiplas páginas para o conteúdo do bloco
          const imgData = canvas.toDataURL('image/png');
          const imgHeight = canvas.height * targetWidth / canvas.width;
          const pageHeight = doc.internal.pageSize.getHeight();
          let heightLeft = imgHeight;
          let yOffset = pdfMargin;
          let pageNumber = 1;

          while (heightLeft > 0) {
              let sHeight = pageHeight - yOffset - pdfMargin;
              let sourceY = imgHeight - heightLeft;

              if (pageNumber > 1) {
                  doc.addPage();
                  yOffset = pdfMargin;
                  sHeight = pageHeight - yOffset - pdfMargin;
              }

              let canvasCrop = document.createElement('canvas');
              let ctx = canvasCrop.getContext('2d');
              canvasCrop.width = canvas.width;
              
              let cropHeightPx = canvas.height * sHeight / imgHeight;

              if (cropHeightPx > canvas.height - sourceY) {
                  cropHeightPx = canvas.height - sourceY;
                  sHeight = imgHeight * cropHeightPx / canvas.height;
              }

              canvasCrop.height = cropHeightPx;

              ctx.drawImage(canvas,
                  0, sourceY,
                  canvas.width, cropHeightPx,
                  0, 0,
                  canvas.width, cropHeightPx
              );

              let croppedImgData = canvasCrop.toDataURL('image/png');

              doc.addImage(
                  croppedImgData,
                  'PNG',
                  pdfMargin,
                  yOffset,
                  targetWidth,
                  sHeight
              );

              heightLeft -= sHeight;
              yOffset += sHeight;
              pageNumber++;
          }

          doc.save(`${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
      } catch (error) {
          console.error('Erro ao gerar PDF do Bloco:', error);
          alert('Ocorreu um erro ao gerar o PDF do Bloco.');
      } finally {
          // Remove a div temporária
          document.body.removeChild(tempDiv);
          spinner.remove();
      }
    }


    // --- Eventos ---
    document.getElementById('addPageBtn').onclick=()=>{createPage(document.getElementById('newPageInput').value.trim()||'Nova página');};
    document.getElementById('deletePageBtn').onclick=()=>{if(activePageId) deletePage(activePageId);};
    document.getElementById('addTextBtn').onclick=openNewBlockModal;
    document.getElementById('generatePdfBtn').onclick = generatePDF; // PDF de todos os blocos
    
    // === 3. ADIÇÃO: Evento para o botão Gerar PDF do Bloco ===
    document.getElementById('generateBlockPdfBtn').onclick = generateBlockPDF;
    // ========================================================
    
    document.getElementById('closeModalBtn').onclick=closeNewBlockModal;
    document.getElementById('saveModalBtn').onclick=handleNewBlock;
    document.getElementById('closeEditModalBtn').onclick=closeEditModal;
    document.getElementById('saveEditModalBtn').onclick=handleSaveEdit;
    document.getElementById('deleteBtn').onclick=()=>deleteBlock(editModalBlockId.value);
    document.getElementById('logoutBtn').onclick=async()=>{await supabase.auth.signOut();};
    searchBar.oninput=(e)=>renderBlocks(e.target.value);

    supabase.auth.onAuthStateChange((ev,session)=>{if(ev==='SIGNED_OUT'){window.location.href='auth.html';}else if(session){currentUser=session.user; loadPages();}});
    supabase.auth.getSession().then(({data:{session}})=>{if(session){currentUser=session.user; loadPages();}});
  </script>
</body>
</html>
