<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SuportAdd</title>
  <style>
    :root{--bg:#3e4754;--card:#04364bfb;--muted:#048487;--accent:#06b6d4;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui;color:#002e37;background:linear-gradient(180deg,#cfe9f6 0%, hsl(182, 100%, 95%) 100%)}
    .app{display:grid;grid-template-columns:280px 1fr;gap:20px;height:100vh;padding:20px}
    .sidebar{background:var(--card);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:12px}
    .logo{font-weight:700;color:var(--accent);font-size:18px}
    .pages{flex:1;overflow:auto}
    .page{background:var(--glass);padding:8px;border-radius:8px;margin-bottom:8px;cursor:pointer}
    .page.active{outline:2px solid rgba(255, 3, 3, 0.069)}
    .new-page{display:flex;gap:8px}
    .btn{background:white;border:1px solid rgba(116, 116, 116, 0.963);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .main{padding:18px;}
    .card{background:#f0f9f9;padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(1, 1, 1, 0.6)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .controls{display:flex;gap:8px}

    /* Estilo dos botoes atualizado*/
    .btn {
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-weight: bold;
      background: linear-gradient(to right, #007bff, #0056b3);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: background 0.3s ease;
    }
    .btn:hover {
        background: linear-gradient(to right, #0056b3, #007bff);
    }
    .btn:active {
      transform: translateY(1px);
    }
    .danger {
      background: #dc3545;
      color: white;
    }
    .danger:hover {
      background: #c82333;
    }

    /* GRID */
    .blocks {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .block, .attach-item {
      background:#01646415;
      padding:12px;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0, 0, 0, 0.114);
      display:flex;
      flex-direction:column;
      gap:8px;
      cursor: pointer;
    }

    .block h3, .block p {
      margin: 0;
    }

    .block textarea {
      width:100%;
      height:120px;
      background:transparent;
      border:1px solid #ddd;
      border-radius:8px;
      padding:6px;
      resize:vertical;
      outline:none
    }

    .title-input {
      font-weight:bold;
      border:1px solid #ccc;
      padding:6px;
      border-radius:8px;
    }

    .attachments {
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .small{font-size:13px;color:var(--muted)}
    
    input[type=file]{display:none}
    @media(max-width:860px){
      .app{grid-template-columns:1fr;grid-auto-rows:auto;overflow:auto;height:auto}
      .sidebar{order:2}
      .blocks{grid-template-columns:1fr}
    }

    /* Estilos do Modal */
    dialog {
      border: none;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      max-width: 900px;
      width: 90%;
      background: #fff;
    }
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .modal-content input, .modal-content textarea, .modal-content .btn {
      width: 100%;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Define um tamanho fixo para o campo de texto do modal */
    #editBlockModal textarea, #newBlockModal textarea {
      height: 120px;
      resize: none;
    }

    /* Novo estilo de grade para os anexos */
    #editModalFileList, #modalFileList {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .attach-item {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        background: #f0f9f9;
        padding: 8px;
        border-radius: 8px;
        box-shadow: none;
    }
    .attach-item img {
        max-width: 100%;
        height: auto;
        margin-bottom: 8px;
        border-radius: 6px;
    }
    .attach-item .file-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .attach-item .actions {
        display: flex;
        gap: 8px;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar card">
      <div class="logo">Suport - ADD </div>
      <div class="pages" id="pages"></div>
      <div class="new-page">
        <input id="newPageInput" class="btn" placeholder="Nome da p√°gina" />
        <button id="addPageBtn" class="btn">Criar</button>
      </div>
    </aside>

    <main class="main">
      <div class="card">
        <header>
          <h1 id="pageTitle">P√°gina</h1>
          <input type="text" id="searchBar" class="btn" placeholder="Pesquisar..." />
          <div class="controls">
            <button id="addTextBtn" class="btn">Adicionar bloco de texto</button>
            <button id="deletePageBtn" class="btn danger">Excluir p√°gina</button>
            <button id="logoutBtn" class="btn danger">Sair</button>
          </div>
        </header>

        <section class="blocks" id="blocksContainer"></section>
      </div>
    </main>
  </div>

  <dialog id="newBlockModal">
    <div class="modal-content">
      <h2>Novo Bloco de Texto</h2>
      <input type="text" id="modalTitle" placeholder="Novo t√≥pico" class="title-input" />
      <textarea id="modalContent" placeholder="Adicionar texto aqui"></textarea>
      
      <div class="file-upload">
        <label class="btn">
          Adicionar arquivos
          <input type="file" id="modalFiles" multiple style="display: none;" />
        </label>
        <div id="modalFileList"></div>
      </div>
      
      <textarea id="modalContentPart2" placeholder="Adicionar mais texto aqui"></textarea>

      <div class="modal-buttons">
        <button id="closeModalBtn" class="btn">Cancelar</button>
        <button id="saveModalBtn" class="btn">Salvar</button>
      </div>
    </div>
  </dialog>

  <dialog id="editBlockModal">
    <div class="modal-content">
      <input type="hidden" id="editModalBlockId" />
      <h2>Detalhes do Bloco</h2>
      <input type="text" id="editModalTitleInput" class="title-input" />
      <textarea id="editModalContentTextarea" class="title-input"></textarea>

      <div class="file-upload">
        <label class="btn">
          Adicionar arquivos
          <input type="file" id="editModalFilesInput" multiple style="display: none;" />
        </label>
      </div>
      <div id="editModalFileList"></div>
      
      <div class="modal-buttons">
        <button id="closeEditModalBtn" class="btn">Fechar</button>
        <button id="saveEditModalBtn" class="btn">Salvar Altera√ß√µes</button>
        <button id="deleteBtn" class="btn danger">Excluir Bloco</button>
      </div>
    </div>
  </dialog>


  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üîë Suas credenciais Supabase
    const SUPABASE_URL = "https://ybpyncfnzfrobqcuiyqr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicHluY2ZuemZyb2JxY3VpeXFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMzY0MDUsImV4cCI6MjA3MzcxMjQwNX0.s_vaIyn8kDkORC2nW-aOgk_4f3ZlsGNqxjgPGFfjVBc";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const pagesEl = document.getElementById('pages');
    const blocksContainer = document.getElementById('blocksContainer');
    const pageTitle = document.getElementById('pageTitle');
    
    // Elementos do Modal de Cria√ß√£o
    const newBlockModal = document.getElementById('newBlockModal');
    const modalTitleInput = document.getElementById('modalTitle');
    const modalContentTextarea = document.getElementById('modalContent');
    const modalFilesInput = document.getElementById('modalFiles');
    const modalFileListDiv = document.getElementById('modalFileList');
    const modalContentPart2Textarea = document.getElementById('modalContentPart2'); // Novo elemento

    // Novos elementos do Modal de Edi√ß√£o
    const editBlockModal = document.getElementById('editBlockModal');
    const editModalBlockId = document.getElementById('editModalBlockId');
    const editModalTitleInput = document.getElementById('editModalTitleInput');
    const editModalContentTextarea = document.getElementById('editModalContentTextarea');
    const editModalFileList = document.getElementById('editModalFileList');
    const editModalFilesInput = document.getElementById('editModalFilesInput');
    
    // Adicionamos a barra de pesquisa
    const searchBar = document.getElementById('searchBar');

    let pages = [];
    let activePageId = null;
    let currentUser = null;
    let currentBlocks = []; // Vari√°vel para armazenar todos os blocos da p√°gina atual
    let filesToUpload = []; // Array para armazenar os arquivos antes de salvar

    // --- P√°ginas ---
    async function loadPages(){
      if (!currentUser) return;
      
      const { data, error } = await supabase.from('pages').select('*').order('created_at', { ascending:false });
      if(error) console.error(error);
      pages = data || [];
      
      // Carrega o ID da p√°gina ativa do LocalStorage
      const savedPageId = localStorage.getItem('activePageId');
      if (savedPageId && pages.some(p => p.id === savedPageId)) {
        activePageId = savedPageId;
      } else if (pages.length) {
        activePageId = pages[0].id;
      } else {
        activePageId = null;
      }
      
      renderPages();
      render();
    }

    async function createPage(title){
      if (!currentUser) {
        alert('Voc√™ precisa estar logado para criar uma p√°gina.');
        return;
      }
      const { data, error } = await supabase.from('pages').insert({ title, user_id: currentUser.id }).select().single();
      if(error) return alert(error.message);
      pages.unshift(data);
      activePageId = data.id;
      localStorage.setItem('activePageId', activePageId); // Salva o novo ID
      renderPages();
      render();
    }

    async function deletePage(id){
      if(!confirm("Excluir p√°gina?")) return;
      const { error } = await supabase.from('pages').delete().eq('id', id);
      if(error) return alert(error.message);
      pages = pages.filter(p=>p.id!==id);
      activePageId = pages[0]?.id || null;
      if (activePageId) {
        localStorage.setItem('activePageId', activePageId);
      } else {
        localStorage.removeItem('activePageId');
      }
      renderPages();
      render();
    }

    function renderPages(){
      pagesEl.innerHTML = '';
      pages.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'page' + (p.id===activePageId? ' active':'');
        div.textContent = p.title;
        div.onclick = ()=>{ 
          activePageId=p.id; 
          localStorage.setItem('activePageId', activePageId); // Salva o ID ao clicar
          render(); 
        };
        pagesEl.appendChild(div);
      });
    }

    // --- Blocos ---
    async function loadBlocks(){
      if(!activePageId) return [];
      const { data, error } = await supabase.from('blocks').select('*').eq('page_id', activePageId).order('created_at');
      if(error) console.error(error);
      currentBlocks = data || []; // Armazena os blocos na vari√°vel global
      return currentBlocks;
    }
    
    // Fun√ß√£o para lidar com a cria√ß√£o de um novo bloco via modal
    async function handleNewBlock() {
      if (!currentUser || !activePageId) {
        alert('Voc√™ precisa estar logado e ter uma p√°gina selecionada para adicionar um bloco.');
        return;
      }
      
      const title = modalTitleInput.value.trim() || "Novo t√≥pico";
      const content = modalContentTextarea.value.trim() || '';
      const contentPart2 = modalContentPart2Textarea.value.trim() || ''; // Captura o valor do novo campo

      // Concatena os textos com quebra de linha
      const fullContent = content + '\n\n' + contentPart2;
      
      // Cria o bloco primeiro
      const { data, error } = await supabase.from('blocks').insert({
        page_id: activePageId,
        title: title,
        content: fullContent, // Salva o conte√∫do combinado
        user_id: currentUser.id
      }).select().single();

      if (error) {
        return alert(error.message);
      }
      
      // Em seguida, adiciona os anexos se existirem
      if (filesToUpload.length > 0) {
        await addFileAttachments(filesToUpload, data.id);
      }
      
      // Adiciona o novo bloco √† lista local
      currentBlocks.push(data);
      
      // Chama a fun√ß√£o que fecha o modal e limpa os campos
      closeNewBlockModal();
      
      renderBlocks(); // Recarrega os blocos
    }

    async function updateBlock(id, fields){
      await supabase.from('blocks').update(fields).eq('id', id);
    }

    async function deleteBlock(id){
      if(!confirm("Tem certeza que deseja excluir este bloco?")) return;
      await supabase.from('blocks').delete().eq('id', id);
      render();
    }

    // --- Anexos ---
    async function addFileAttachments(fileList, blockId){
      const arr = Array.from(fileList);
      for(const file of arr){
        const path = `${activePageId}/${blockId}/${Date.now()}_${file.name}`;
        let { error: upError } = await supabase.storage.from('uploads').upload(path, file);
        if(upError) { alert(upError.message); continue; }
        
        const { error: attachError } = await supabase.from('attachments').insert({
          page_id: activePageId,
          block_id: blockId,
          name: file.name,
          size: file.size,
          type: file.type,
          storage_path: path,
          user_id: currentUser.id
        });
        
        if (attachError) {
          alert('Erro ao inserir anexo: ' + attachError.message);
        }
      }
    }

    // Nova fun√ß√£o para renderizar os anexos no modal de edi√ß√£o
    async function renderAttachments(blockId) {
        editModalFileList.innerHTML = '';
        const { data, error } = await supabase.from('attachments').select('*').eq('block_id', blockId);
        if (error) {
            console.error('Erro ao carregar anexos:', error);
            return;
        }
        
        data.forEach(attachment => {
            const item = document.createElement('div');
            item.className = 'attach-item';
            
            // Verifica se o anexo √© uma imagem para exibir a visualiza√ß√£o
            if (attachment.type.startsWith('image/')) {
                const { data: { publicUrl } } = supabase.storage.from('uploads').getPublicUrl(attachment.storage_path);
                const img = document.createElement('img');
                img.src = publicUrl;
                item.appendChild(img);
            } else {
                const fileName = document.createElement('span');
                fileName.textContent = attachment.name;
                item.appendChild(fileName);
            }

            const actions = document.createElement('div');
            actions.className = 'actions';

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn download-btn';
            downloadBtn.textContent = 'Download';
            downloadBtn.onclick = () => downloadAttachment(attachment.storage_path, attachment.name);
            actions.appendChild(downloadBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn danger delete-attach-btn';
            deleteBtn.textContent = 'Excluir';
            deleteBtn.onclick = () => deleteAttachment(attachment.id, attachment.storage_path);
            actions.appendChild(deleteBtn);

            item.appendChild(actions);
            editModalFileList.appendChild(item);
        });
    }

    // Fun√ß√£o de download do anexo
    async function downloadAttachment(path, fileName) {
      const { data, error } = await supabase.storage.from('uploads').download(path);
      if (error) return alert('Erro ao baixar arquivo: ' + error.message);

      const url = URL.createObjectURL(data);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Fun√ß√£o para excluir anexo
    async function deleteAttachment(id, path) {
        if (!confirm("Tem certeza que deseja excluir este anexo?")) return;
        
        const { error: dbError } = await supabase.from('attachments').delete().eq('id', id);
        if (dbError) return alert('Erro ao excluir anexo: ' + dbError.message);
        
        const { error: storageError } = await supabase.storage.from('uploads').remove([path]);
        if (storageError) return alert('Erro ao excluir arquivo do storage: ' + storageError.message);
        
        alert("Anexo exclu√≠do com sucesso!");
        renderAttachments(editModalBlockId.value);
    }

    // Nova fun√ß√£o para visualizar arquivos ANTES de salvar (no modal de cria√ß√£o)
    function handleFileSelection(files, container) {
      container.innerHTML = '';
      filesToUpload = Array.from(files);
      filesToUpload.forEach(file => {
          const item = document.createElement('div');
          item.className = 'attach-item';
          
          if (file.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = URL.createObjectURL(file);
              item.appendChild(img);
          } else {
              const fileName = document.createElement('span');
              fileName.textContent = file.name;
              item.appendChild(fileName);
          }

          const actions = document.createElement('div');
          actions.className = 'actions';

          // Bot√£o para remover do "pr√©-upload"
          const removeBtn = document.createElement('button');
          removeBtn.className = 'btn danger delete-attach-btn';
          removeBtn.textContent = 'Remover';
          removeBtn.onclick = () => {
              filesToUpload = filesToUpload.filter(f => f.name !== file.name);
              item.remove();
          };
          actions.appendChild(removeBtn);

          item.appendChild(actions);
          container.appendChild(item);
      });
    }


    // --- Render Blocos com anexos (Fun√ß√£o atualizada com pesquisa) ---
    function renderBlocks(searchTerm = ''){
      blocksContainer.innerHTML = '';
      const blocksToRender = currentBlocks.filter(block => {
        // Transforma o termo de busca e os textos do bloco em min√∫sculas para uma compara√ß√£o sem distin√ß√£o de mai√∫sculas/min√∫sculas
        const lowerCaseSearch = searchTerm.toLowerCase();
        const titleMatch = block.title.toLowerCase().includes(lowerCaseSearch);
        const contentMatch = block.content.toLowerCase().includes(lowerCaseSearch);
        return titleMatch || contentMatch;
      });

      blocksToRender.forEach(b => {
        const card = document.createElement('div');
        card.className = 'block';

        // N√£o mais edit√°vel diretamente. Clique no bloco para abrir o modal.
        card.innerHTML = `
          <h3>${b.title}</h3>
          <p>${b.content}</p>
        `;
        
        // Adiciona o evento de clique para abrir o modal de edi√ß√£o
        card.onclick = () => {
          openEditModal(b);
        };
        
        blocksContainer.appendChild(card);
      });
    }
    
    // --- Render principal (Fun√ß√£o atualizada para a pesquisa) ---
    async function render(){
      const p = pages.find(x=>x.id===activePageId);
      if(!p){ pageTitle.textContent = 'Nenhuma p√°gina'; return; }
      pageTitle.textContent = p.title;
      await loadBlocks(); // Garante que os blocos est√£o carregados antes de renderizar
      renderBlocks(searchBar.value); // Chama a renderiza√ß√£o com o valor atual da barra de pesquisa
    }
    
    // --- Fun√ß√µes do Modal de Cria√ß√£o ---
    function openNewBlockModal() {
      newBlockModal.showModal();
    }
    function closeNewBlockModal() {
      newBlockModal.close();
      // Limpar os campos do modal
      modalTitleInput.value = '';
      modalContentTextarea.value = '';
      modalContentPart2Textarea.value = ''; // Limpa o novo campo
      modalFilesInput.value = null;
      modalFileListDiv.innerHTML = '';
      filesToUpload = [];
    }
    
    // --- Fun√ß√µes do Modal de Edi√ß√£o ---
    function openEditModal(blockData) {
      editModalBlockId.value = blockData.id;
      editModalTitleInput.value = blockData.title;
      editModalContentTextarea.value = blockData.content;
      renderAttachments(blockData.id); // Carrega e exibe os anexos do bloco
      editBlockModal.showModal();
    }

    async function handleSaveEdit() {
      const blockId = editModalBlockId.value;
      const newTitle = editModalTitleInput.value;
      const newContent = editModalContentTextarea.value;
      const newFiles = editModalFilesInput.files;

      await updateBlock(blockId, { title: newTitle, content: newContent });
      if (newFiles.length > 0) {
        await addFileAttachments(newFiles, blockId);
      }

      editBlockModal.close();
      render();
    }

    // Eventos
    document.getElementById('addPageBtn').onclick = ()=>{
      const v = document.getElementById('newPageInput').value.trim();
      createPage(v||'Nova p√°gina');
      document.getElementById('newPageInput').value='';
    };
    document.getElementById('deletePageBtn').onclick = ()=>{ if(activePageId) deletePage(activePageId); };
    
    // Eventos do Modal de Cria√ß√£o
    document.getElementById('addTextBtn').onclick = openNewBlockModal;
    document.getElementById('closeModalBtn').onclick = closeNewBlockModal;
    document.getElementById('saveModalBtn').onclick = handleNewBlock;
    modalFilesInput.addEventListener('change', (e) => handleFileSelection(e.target.files, modalFileListDiv));

    // Eventos do Modal de Edi√ß√£o
    document.getElementById('closeEditModalBtn').onclick = () => {
      editBlockModal.close();
    };
    document.getElementById('saveEditModalBtn').onclick = handleSaveEdit;
    document.getElementById('deleteBtn').onclick = async () => {
      const blockId = editModalBlockId.value;
      await deleteBlock(blockId);
      editBlockModal.close();
    };
    
    // Evento para lidar com a sele√ß√£o de arquivos no modal de edi√ß√£o
    editModalFilesInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        const blockId = editModalBlockId.value;
        if (files.length > 0) {
            await addFileAttachments(files, blockId);
            renderAttachments(blockId);
            e.target.value = ''; // Limpa o input file para permitir novos uploads do mesmo arquivo
        }
    });

    // Altere este bloco de c√≥digo para remover o redirecionamento direto
    document.getElementById('logoutBtn').onclick = async () => {
      await supabase.auth.signOut();
    };

    // Mantenha este bloco de c√≥digo. Ele √© o respons√°vel por redirecionar ap√≥s o evento SIGNED_OUT
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (event === 'SIGNED_OUT') {
        window.location.href = 'auth.html';
      } else if (session) {
        currentUser = session.user;
        loadPages();
      }
    });

    // Adiciona o evento de escuta para a barra de pesquisa
    searchBar.addEventListener('input', (e) => {
      renderBlocks(e.target.value);
    });

    // In√≠cio - Verifica√ß√£o inicial da sess√£o ao carregar a p√°gina
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) {
        currentUser = session.user;
        loadPages();
      }
    });
  </script>
</body>
</html>
