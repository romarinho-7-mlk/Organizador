<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SuportAdd - Dashboard Final</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
  
  <style>
    :root {
      --bg-body: #f4f7fe;
      --sidebar-bg: #ffffff;
      --accent-color: #4361ee;
      --text-main: #2b3674;
      --text-secondary: #a3aed0;
      --card-bg: #ffffff;
      --radius: 16px;
      --shadow: 0px 10px 30px rgba(0, 0, 0, 0.05);
    }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }
    .app { display: grid; grid-template-columns: 280px 1fr; height: 100vh; }

    /* Sidebar com Scroll */
    .sidebar { background: var(--sidebar-bg); border-right: 1px solid #e9edf7; padding: 25px 20px; display: flex; flex-direction: column; gap: 15px; height: 100vh; }
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 20px; font-weight: 800; color: var(--accent-color); margin: 0; }
    .create-page-area { display: flex; gap: 8px; padding-bottom: 15px; border-bottom: 1px solid #e9edf7; }
    .create-page-area input { border: 1px solid #e9edf7; border-radius: 8px; padding: 1px; flex: 1; font-size: 13px; outline: none; }
    
    .pages { flex: 1; overflow-y: auto; padding-right: 5px; }
    .pages::-webkit-scrollbar { width: 5px; }
    .pages::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }

    .page { padding: 10px 15px; border-radius: 10px; color: var(--text-secondary); cursor: pointer; margin-bottom: 5px; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .page.active { background: #f4f7fe; color: var(--accent-color); font-weight: 700; border-left: 4px solid var(--accent-color); }

    /* Main */
    .main { padding: 30px; overflow-y: auto; }
    
    header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 30px; 
      gap: 20px; 
    }
    
    .header-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    header h1 {
      margin: 0;
    }
    
    .search-bar { 
      background: white; 
      border: 1px solid #e9edf7; 
      border-radius: 12px; 
      padding: 12px 20px; 
      width: 100%;
      box-shadow: var(--shadow); 
      outline: none; 
    }

    .controls { 
      display: flex; 
      gap: 10px;
      flex-direction: row;
      align-items: center;
    }

    .blocks { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .block { background: var(--card-bg); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); cursor: pointer; height: 220px; border: 1px solid transparent; overflow: hidden; display: flex; flex-direction: column; }
    .block:hover { border-color: var(--accent-color); transform: translateY(-3px); transition: 0.3s; }
    .content-preview { font-size: 14px; color: var(--text-secondary); overflow: hidden; flex: 1; }
    .content-preview img { max-width: 100%; max-height: 80px; border-radius: 5px; }

    .btn-saas { border-radius: 10px; font-weight: 600; padding: 8px 16px; cursor: pointer; border: none; font-size: 13px; white-space: nowrap; }
    .btn-primary-saas { background: var(--accent-color); color: white; }
    .btn-danger-saas { background: #ee5d50; color: white; }

    /* Modais */
    dialog { border: none; border-radius: var(--radius); padding: 30px; width: 95%; max-width: 1000px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); position: relative; }
    .close-modal-x { position: absolute; top: 20px; right: 20px; background: #f1f1f1; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2 class="logo">SUPORT-ADD</h2>
      <button id="logoutBtn" class="btn-saas btn-danger-saas" style="padding: 5px 10px; font-size: 11px;">Sair</button>
    </div>
    <div class="create-page-area">
      <input id="newPageInput" placeholder="Nova página...">
      <button id="addPageBtn" class="btn-saas btn-primary-saas">Criar</button>
    </div>
    <div class="pages" id="pages"></div>
  </aside>

  <main class="main">
    <header>
      <div class="header-left">
        <h1 id="pageTitle" style="margin:0;">Página</h1>
        <input type="text" id="searchBar" class="search-bar" placeholder="Pesquisar em tudo..." />
      </div>
      <div class="controls">
        <button id="addTextBtn" class="btn-saas btn-primary-saas">Adicionar bloco</button>
        <button id="generatePdfBtn" class="btn-saas btn-primary-saas">Gerar PDF</button>
        <button id="deletePageBtn" class="btn-saas btn-danger-saas">Excluir página</button>
        <button id="logoutBtn2" class="btn-saas btn-danger-saas" style="display:none;">Sair</button>
      </div>
    </header>
    <section class="blocks" id="blocksContainer"></section>
  </main>
</div>

<dialog id="editBlockModal">
  <button class="close-modal-x" id="closeEditX">✕</button>
  <input type="hidden" id="editModalBlockId">
  <h3 class="mb-4">Editar Conteúdo</h3>
  <input type="text" id="editModalTitleInput" class="form-control mb-3" style="border-radius: 10px; font-weight: 700;">
  <div id="editModalEditor"></div>
  <div class="d-flex justify-content-between mt-4">
    <button id="deleteBtn" class="btn-saas btn-danger-saas">Excluir Bloco</button>
    <div class="d-flex gap-2">
      <button id="generateBlockPdfBtn" class="btn-saas btn-primary-saas">Gerar PDF</button>
      <button id="saveEditModalBtn" class="btn-saas btn-primary-saas">Atualizar</button>
    </div>
  </div>
</dialog>

<dialog id="newBlockModal">
  <button class="close-modal-x" id="closeNewX">✕</button>
  <h3 class="mb-4">Novo Bloco</h3>
  <input type="text" id="modalTitle" class="form-control mb-3" placeholder="Título">
  <div id="modalEditor"></div>
  <div class="d-flex justify-content-end mt-4">
    <button id="saveModalBtn" class="btn-saas btn-primary-saas">Criar Bloco</button>
  </div>
</dialog>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const supabase = createClient("https://ybpyncfnzfrobqcuiyqr.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicHluY2ZuemZyb2JxY3VpeXFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMzY0MDUsImV4cCI6MjA3MzcxMjQwNX0.s_vaIyn8kDkORC2nW-aOgk_4f3ZlsGNqxjgPGFfjVBc");

  let pages = [], activePageId = null, currentUser = null, allBlocks = [];

  const summernoteOptions = { height: 350, toolbar: [ ['style', ['style', 'bold', 'italic', 'underline', 'clear']], ['fontsize', ['fontsize']], ['color', ['color']], ['para', ['ul', 'ol', 'paragraph']], ['table', ['table']], ['insert', ['link', 'picture', 'video']], ['view', ['fullscreen', 'codeview']] ] };

  supabase.auth.onAuthStateChange((ev, session) => {
    if (session) { currentUser = session.user; init(); }
    else { window.location.href = 'auth.html'; }
  });

  async function init() {
    const { data: pData } = await supabase.from('pages').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
    pages = pData || [];
    if (pages.length > 0 && !activePageId) activePageId = pages[0].id;
    await loadBlocks();
    render();
  }

  async function loadBlocks() {
    const { data: bData } = await supabase.from('blocks').select('*').eq('user_id', currentUser.id);
    allBlocks = bData || [];
  }

  function render(searchTerm = '') {
    const pagesEl = document.getElementById('pages');
    pagesEl.innerHTML = '';
    pages.forEach(p => {
      const div = document.createElement('div');
      div.className = `page ${p.id === activePageId && !searchTerm ? 'active' : ''}`;
      div.textContent = p.title;
      div.onclick = () => { activePageId = p.id; document.getElementById('searchBar').value = ''; render(); };
      pagesEl.appendChild(div);
    });
    
    // Atualizar o título da página selecionada
    const activePage = pages.find(p => p.id === activePageId);
    document.getElementById('pageTitle').textContent = activePage ? activePage.title : 'Página';

    const container = document.getElementById('blocksContainer');
    container.innerHTML = '';
    let filtered = searchTerm ? 
      allBlocks.filter(b => b.title.toLowerCase().includes(searchTerm.toLowerCase()) || b.content.toLowerCase().includes(searchTerm.toLowerCase())) :
      allBlocks.filter(b => b.page_id === activePageId);

    filtered.forEach(b => {
      const card = document.createElement('div');
      card.className = 'block';
      const blockPage = pages.find(p => p.id === b.page_id);
      const pageLabel = searchTerm && blockPage ? `<div style="border: 2px solid #ee5d50; border-radius: 6px; padding: 4px 8px; font-size: 12px; color: #ee5d50; font-weight: 600; margin-bottom: 10px; display: inline-block;">${blockPage.title}</div>` : '';
      card.innerHTML = `${pageLabel}<h3>${b.title}</h3><div class="content-preview">${b.content}</div>`;
      card.onclick = () => openEditModal(b);
      container.appendChild(card);
    });
  }

  function openEditModal(b) {
    document.getElementById('editModalBlockId').value = b.id;
    document.getElementById('editModalTitleInput').value = b.title;
    $('#editModalEditor').summernote(summernoteOptions).summernote('code', b.content);
    document.getElementById('editBlockModal').showModal();
  }

  function generateCleanPdf(title, htmlContent) {
    const element = document.createElement('div');
    element.innerHTML = `
      <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1 style="color: #2b3674; font-size: 22pt; margin-bottom: 10px; border-bottom: 1px solid #4361ee;">${title}</h1>
        <div style="font-size: 12pt; line-height: 1.5;">${htmlContent}</div>
      </div>
    `;

    const opt = {
      margin: [15, 15, 15, 15],
      filename: `${title}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2, 
        useCORS: true,
        logging: false,
        letterRendering: true
      },
      jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save();
  }

  document.getElementById('generateBlockPdfBtn').onclick = () => {
    const title = document.getElementById('editModalTitleInput').value;
    const content = $('#editModalEditor').summernote('code');
    generateCleanPdf(title, content);
  };

  document.getElementById('generatePdfBtn').onclick = () => {
    const activePage = pages.find(p => p.id === activePageId);
    const title = activePage ? activePage.title : "Relatório";
    const blocks = allBlocks.filter(b => b.page_id === activePageId);
    let fullHtml = "";
    blocks.forEach(b => {
      fullHtml += `<div style="margin-bottom:40px;"><h2 style="color:#4361ee;">${b.title}</h2>${b.content}</div>`;
    });
    generateCleanPdf(title, fullHtml);
  };

  // Eventos Gerais
  document.getElementById('logoutBtn').onclick = () => supabase.auth.signOut();
  document.getElementById('closeEditX').onclick = () => document.getElementById('editBlockModal').close();
  document.getElementById('closeNewX').onclick = () => document.getElementById('newBlockModal').close();
  document.getElementById('searchBar').oninput = (e) => render(e.target.value);
  document.getElementById('saveEditModalBtn').onclick = async () => {
    const id = document.getElementById('editModalBlockId').value;
    const title = document.getElementById('editModalTitleInput').value;
    const content = $('#editModalEditor').summernote('code');
    await supabase.from('blocks').update({ title, content }).eq('id', id);
    document.getElementById('editBlockModal').close();
    await loadBlocks(); render();
  };
  document.getElementById('addTextBtn').onclick = () => {
    $('#modalEditor').summernote(summernoteOptions).summernote('code', '');
    document.getElementById('newBlockModal').showModal();
  };
  document.getElementById('saveModalBtn').onclick = async () => {
    const title = document.getElementById('modalTitle').value;
    const content = $('#modalEditor').summernote('code');
    await supabase.from('blocks').insert({ title, content, page_id: activePageId, user_id: currentUser.id });
    document.getElementById('newBlockModal').close();
    await loadBlocks(); render();
  };
  document.getElementById('addPageBtn').onclick = async () => {
    const title = document.getElementById('newPageInput').value;
    if(!title) return;
    const { data } = await supabase.from('pages').insert({ title, user_id: currentUser.id }).select().single();
    activePageId = data.id; init();
  };
  document.getElementById('deletePageBtn').onclick = async () => {
    if (confirm("Excluir página?")) {
      await supabase.from('blocks').delete().eq('page_id', activePageId);
      await supabase.from('pages').delete().eq('id', activePageId);
      activePageId = null; init();
    }
  };
</script>
</body>
</html>
