<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini-Notion com Supabase</title>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // 游댐 Substitua pelas suas credenciais do Supabase
    const SUPABASE_URL = "https://ybpyncfnzfrobqcuiyqr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicHluY2ZuemZyb2JxY3VpeXFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMzY0MDUsImV4cCI6MjA3MzcxMjQwNX0.s_vaIyn8kDkORC2nW-aOgk_4f3ZlsGNqxjgPGFfjVBc";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const pagesEl = document.getElementById('pages');
    const blocksContainer = document.getElementById('blocksContainer');
    const attachmentsEl = document.getElementById('attachments');
    const pageTitle = document.getElementById('pageTitle');

    let pages = [];
    let activePageId = null;

    // --- P치ginas ---
    async function loadPages(){
      const { data, error } = await supabase.from('pages').select('*').order('created_at', { ascending:false });
      if(error) console.error(error);
      pages = data || [];
      if(!activePageId && pages.length) activePageId = pages[0].id;
      renderPages();
      render();
    }

    async function createPage(title){
      const { data, error } = await supabase.from('pages').insert({ title }).select().single();
      if(error) return alert(error.message);
      pages.unshift(data);
      activePageId = data.id;
      renderPages();
      render();
    }

    async function deletePage(id){
      if(!confirm("Excluir p치gina?")) return;
      const { error } = await supabase.from('pages').delete().eq('id', id);
      if(error) return alert(error.message);
      pages = pages.filter(p=>p.id!==id);
      activePageId = pages[0]?.id || null;
      renderPages();
      render();
    }

    function renderPages(){
      pagesEl.innerHTML = '';
      pages.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'page' + (p.id===activePageId? ' active':'');
        div.textContent = p.title;
        div.onclick = ()=>{ activePageId=p.id; render(); };
        pagesEl.appendChild(div);
      });
    }

    // --- Blocos de texto ---
    async function loadBlocks(){
      if(!activePageId) return [];
      const { data, error } = await supabase.from('blocks').select('*').eq('page_id', activePageId).order('created_at');
      if(error) console.error(error);
      return data || [];
    }

    async function addTextBlock(){
      const { data, error } = await supabase.from('blocks').insert({ page_id: activePageId, content:'' }).select().single();
      if(error) return alert(error.message);
      render();
    }

    async function updateBlock(id, content){
      await supabase.from('blocks').update({ content }).eq('id', id);
    }

    async function deleteBlock(id){
      await supabase.from('blocks').delete().eq('id', id);
      render();
    }

    async function renderBlocks(){
      blocksContainer.innerHTML = '';
      const blocks = await loadBlocks();
      blocks.forEach(b=>{
        const wrap = document.createElement('div'); wrap.className='block';
        const ta = document.createElement('textarea'); ta.value = b.content || '';
        ta.oninput = e=> updateBlock(b.id, e.target.value);
        wrap.appendChild(ta);
        const del = document.createElement('button'); del.className='btn danger'; del.textContent='Remover bloco';
        del.onclick = ()=> deleteBlock(b.id);
        wrap.appendChild(del);
        blocksContainer.appendChild(wrap);
      });
    }

    // --- Anexos ---
    async function loadAttachments(){
      if(!activePageId) return [];
      const { data, error } = await supabase.from('attachments').select('*').eq('page_id', activePageId).order('created_at');
      if(error) console.error(error);
      return data || [];
    }

    async function addFileAttachments(fileList){
      const arr = Array.from(fileList);
      for(const file of arr){
        const path = `${activePageId}/${Date.now()}_${file.name}`;
        let { error: upError } = await supabase.storage.from('uploads').upload(path, file);
        if(upError) { alert(upError.message); continue; }
        await supabase.from('attachments').insert({
          page_id: activePageId,
          name: file.name,
          size: file.size,
          type: file.type,
          storage_path: path
        });
      }
      renderAttachments();
    }

    async function renderAttachments(){
      attachmentsEl.innerHTML = '';
      const list = await loadAttachments();
      list.forEach(a=>{
        const item = document.createElement('div'); item.className='attach-item';
        const left = document.createElement('div'); left.innerHTML = `<div><strong>${a.name}</strong></div><div class='small'>${Math.round(a.size/1024)} KB</div>`;
        const right = document.createElement('div');
        const dl = document.createElement('button'); dl.className='btn'; dl.textContent='Abrir';
        dl.onclick = async ()=>{
          const { data } = supabase.storage.from('uploads').getPublicUrl(a.storage_path);
          window.open(data.publicUrl, '_blank');
        };
        const rm = document.createElement('button'); rm.className='btn danger'; rm.textContent='Remover';
        rm.onclick = async ()=>{
          if(!confirm('Remover anexo?')) return;
          await supabase.from('attachments').delete().eq('id', a.id);
          await supabase.storage.from('uploads').remove([a.storage_path]);
          renderAttachments();
        };
        right.appendChild(dl); right.appendChild(rm);
        item.appendChild(left); item.appendChild(right);
        attachmentsEl.appendChild(item);
      });
    }

    // --- Render principal ---
    async function render(){
      const p = pages.find(x=>x.id===activePageId);
      if(!p){ pageTitle.textContent = 'Nenhuma p치gina'; return; }
      pageTitle.textContent = p.title;
      renderBlocks();
      renderAttachments();
    }

    // Eventos
    document.getElementById('addPageBtn').onclick = ()=>{
      const v = document.getElementById('newPageInput').value.trim();
      createPage(v||'Nova p치gina');
      document.getElementById('newPageInput').value='';
    };
    document.getElementById('deletePageBtn').onclick = ()=>{ if(activePageId) deletePage(activePageId); };
    document.getElementById('addTextBtn').onclick = ()=> addTextBlock();
    document.getElementById('fileInput').onchange = e=> addFileAttachments(e.target.files);

    document.getElementById('dropZone').addEventListener('drop', e=>{ e.preventDefault(); if(e.dataTransfer?.files) addFileAttachments(e.dataTransfer.files); });
    document.getElementById('dropZone').addEventListener('dragover', e=> e.preventDefault());

    // In칤cio
    loadPages();
  </script>
  <style>
    /* Reuso do estilo anterior */
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui;color:#e6eef6;background:linear-gradient(180deg,#071022 0%, #071827 100%)}
    .app{display:grid;grid-template-columns:280px 1fr;gap:20px;height:100vh;padding:20px}
    .sidebar{background:var(--card);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:12px}
    .logo{font-weight:700;color:var(--accent);font-size:18px}
    .pages{flex:1;overflow:auto}
    .page{background:var(--glass);padding:8px;border-radius:8px;margin-bottom:8px;cursor:pointer}
    .page.active{outline:2px solid rgba(6,182,212,0.12)}
    .new-page{display:flex;gap:8px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .main{padding:18px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .controls{display:flex;gap:8px}
    .blocks{display:flex;flex-direction:column;gap:12px}
    .block{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    .block textarea{width:100%;height:120px;background:transparent;border:0;color:inherit;resize:vertical;outline:none}
    .file-drop{border:2px dashed rgba(255,255,255,0.04);padding:18px;border-radius:10px;text-align:center;color:var(--muted)}
    .attachments{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .attach-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
    .small{font-size:13px;color:var(--muted)}
    .danger{color:#ff7b7b}
    input[type=file]{display:none}
    @media(max-width:860px){.app{grid-template-columns:1fr;grid-auto-rows:auto;overflow:auto;height:auto}.sidebar{order:2}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar card">
      <div class="logo">Suporte-ADD</div>
      <div class="pages" id="pages"></div>
      <div class="new-page">
        <input id="newPageInput" class="btn" placeholder="Nome da p치gina" />
        <button id="addPageBtn" class="btn">Criar</button>
      </div>
    </aside>

    <main class="main">
      <div class="card">
        <header>
          <h1 id="pageTitle">P치gina</h1>
          <div class="controls">
            <label class="btn">
              <span class="small">Adicionar arquivo</span>
              <input id="fileInput" type="file" multiple />
            </label>
            <button id="addTextBtn" class="btn">Adicionar bloco de texto</button>
            <button id="deletePageBtn" class="btn danger">Excluir p치gina</button>
          </div>
        </header>

        <section class="blocks" id="blocksContainer"></section>

        <section class="block">
          <div class="file-drop" id="dropZone">Arraste arquivos aqui ou use "Adicionar arquivo"</div>
          <div class="attachments" id="attachments"></div>
        </section>
      </div>
    </main>
  </div>
</body>
</html>
